<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Magic Christmas Tree ‚Äì Full Interactive</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body { margin:0; overflow:hidden; background:#000; font-family:sans-serif }
#ui { position:absolute; bottom:20px; width:100%; text-align:center; z-index:10 }
button {
  padding:15px 40px;
  font-size:18px;
  font-weight:bold;
  border-radius:30px;
  border:2px solid gold;
  background:linear-gradient(#c00,#800);
  color:white;
}
#cam { position:absolute; top:10px; right:10px; width:120px; height:90px; opacity:.6; transform:scaleX(-1) }
</style>
</head>

<body>
<div id="ui">
  <div style="color:#fff;opacity:.7;margin-bottom:10px">
    ‚úä Fist = Tree | üñê Open = Explode | ‚úåÔ∏è Two fingers = Open Image | ‚ù§Ô∏è Two hands = Love
  </div>
  <button onclick="start()">START MAGIC</button>
</div>

<canvas id="cam"></canvas>

<script>
/* ================== CONFIG ================== */
const IMAGE_COUNT = 15;
const photoFiles = Array.from({length:IMAGE_COUNT},(_,i)=>`./image${i+1}.jpeg`);

const CONFIG = {
  treeHeight: 70,
  treeRadius: 35,
  orbitRadius: 28
};

let scene,camera,renderer;
let gold,photos=[];
let state="TREE";
let selected=0;
let handPos={x:0,y:0};

/* ================== INIT ================== */
function start(){
  document.getElementById("ui").style.display="none";
  init3D();
  initHands();
}

function init3D(){
  scene=new THREE.Scene();
  scene.fog=new THREE.FogExp2(0x000000,0.002);

  camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);
  camera.position.z=120;

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  createTree();
  createPhotos();
  animate();
}

/* ================== TREE ================== */
function createTree(){
  const geo=new THREE.BufferGeometry();
  const count=2000;
  const pos=[];

  for(let i=0;i<count;i++){
    const h=Math.random()*CONFIG.treeHeight;
    const r=(1-h/CONFIG.treeHeight)*CONFIG.treeRadius*Math.random();
    const t=Math.random()*Math.PI*2;
    pos.push(Math.cos(t)*r,h-CONFIG.treeHeight/2,Math.sin(t)*r);
  }

  geo.setAttribute("position",new THREE.Float32BufferAttribute(pos,3));
  const mat=new THREE.PointsMaterial({
    size:2,
    color:0xffd700,
    transparent:true,
    blending:THREE.AdditiveBlending
  });
  gold=new THREE.Points(geo,mat);
  scene.add(gold);
}

/* ================== PHOTOS ================== */
function createPhotos(){
  const loader=new THREE.TextureLoader();
  const geo=new THREE.PlaneGeometry(8,8);

  photoFiles.forEach((src,i)=>{
    const mat=new THREE.MeshBasicMaterial({map:loader.load(src),side:THREE.DoubleSide});
    const mesh=new THREE.Mesh(geo,mat);

    const h=Math.random()*CONFIG.treeHeight-CONFIG.treeHeight/2;
    const r=Math.random()*CONFIG.treeRadius*(1-Math.abs(h)/CONFIG.treeHeight);
    const t=Math.random()*Math.PI*2;

    mesh.userData.home=new THREE.Vector3(
      Math.cos(t)*r,
      h,
      Math.sin(t)*r
    );

    mesh.position.copy(mesh.userData.home);
    scene.add(mesh);
    photos.push(mesh);
  });
}

/* ================== ANIMATE ================== */
function animate(){
  requestAnimationFrame(animate);

  gold.rotation.y+=0.002;
  gold.position.x=handPos.x*40;
  gold.position.y=handPos.y*30;

  if(state==="EXPLODE"){
    photos.forEach((m,i)=>{
      const angle=i*(Math.PI*2/photos.length);
      const target=new THREE.Vector3(
        Math.sin(angle)*CONFIG.orbitRadius,
        Math.sin(Date.now()*0.002+i)*4,
        Math.cos(angle)*CONFIG.orbitRadius
      );
      m.position.lerp(target,0.08);
      m.lookAt(camera.position);
    });
  }

  if(state==="TREE"){
    photos.forEach(m=>{
      m.position.lerp(m.userData.home,0.08);
      m.scale.lerp(new THREE.Vector3(0.8,0.8,0.8),0.1);
    });
  }

  if(state==="PHOTO"){
    photos.forEach((m,i)=>{
      if(i===selected){
        m.position.lerp(new THREE.Vector3(0,0,60),0.1);
        m.scale.lerp(new THREE.Vector3(5,5,5),0.1);
      }else{
        m.scale.lerp(new THREE.Vector3(0,0,0),0.1);
      }
    });
  }

  renderer.render(scene,camera);
}

/* ================== HANDS ================== */
function initHands(){
  const video=document.createElement("video");
  const camCanvas=document.getElementById("cam");
  const ctx=camCanvas.getContext("2d");

  const hands=new Hands({
    locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });

  hands.setOptions({
    maxNumHands:2,
    minDetectionConfidence:.5,
    minTrackingConfidence:.5
  });

  hands.onResults(res=>{
    ctx.clearRect(0,0,120,90);
    ctx.drawImage(res.image,0,0,120,90);

    if(res.multiHandLandmarks.length===2){
      state="HEART";
      return;
    }

    if(res.multiHandLandmarks.length){
      const lm=res.multiHandLandmarks[0];
      handPos.x=lm[9].x-.5;
      handPos.y=.5-lm[9].y;

      const pinch=Math.hypot(lm[4].x-lm[8].x,lm[4].y-lm[8].y);
      const open=Math.hypot(lm[8].x-lm[0].x,lm[8].y-lm[0].y);

      if(pinch<0.05){
        state="PHOTO";
      }else if(open>0.3){
        state="EXPLODE";
      }else{
        state="TREE";
      }
    }
  });

  const cam=new Camera(video,{
    onFrame:async()=>hands.send({image:video}),
    width:320,height:240
  });
  cam.start();
}

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
